# Amazon GuardDuty Malware Protection for Amazon S3

This example uses .

## Build

To build this app, you need to be in the root cdk folder. Then run the following:

```bash
cd cdk
npm install -g aws-cdk
npm ci
```

This will install the necessary CDK, then this example's dependencies, and then build your TypeScript files and your CloudFormation template.

## Bootstrap AWS Account (if required)

This stack uses assets, so the toolkit stack must be deployed to the AWS Account region that you intend to deploy too. If you have deployed other CDK projects into the account, this will not be required. To bootstrap the Account Region with CDK this can be done by running the following command:

```shell script
cdk bootstrap aws://account-id/aws-region
```

## Components

This CDK app has components:

- GuardDuty Malware Protection and required IAM Role (GuardDutyS3Stack)
- An S3 protected bucket (S3MalwareProtectedBucket)
- An S3 clean bucket (S3MalwareCleanBucket)
- Lambda copy function to move clean files (S3MalwareCleanBucket)
- EventBridge Rule to trigger the Lambda copy (S3MalwareCleanBucket)
- Custom Resource to delay provisioning due to race condition (LambdaDelayStack)

## Deploy ALL

To deploy / redeploy the stack to your AWS Account, run

```shell script
npm run deploy
```

After the deployment you will see all resources to support an end-to-end workflow.

## Deploy Minimal Resources

To deploy **ONLY** the Source Bucket and the GuardDuty Malware Protection Plan, run

```shell script
npm run deploy-min
```

**NOTE:** This gives you the minimum requirements to run Malware Protection on an S3 bucket.

After the deployment you will see source Bucket and a Protection Plan for S3 in the GuardDuty Console.

## Synthesize Cloudformation Template

To see the Cloudformation template generated by the CDK, run `cdk synth`, then check the output file in the "cdk.out" directory.

## CDK Nag

Included the AwsSolutions NagPack into the application.

## Delete / Cleanup

To cleanup the solution

```shell script
npm run destroy
```
