# Cloudformation Scenarios

The following scenarios are supported within the `template.yaml`.

- `NewBucketKMS`
  - Creates a new encrypted S3 bucket for scanning using server-side encryption with AWS KMS keys (SSE-KMS)
  - Creates a new KMS key
  - Creates a malware protection plan
- `NewBucketNoKMS`
  - Creates a new encrypted S3 bucket for scanning using server-side encryption with S3-managed keys (SSE-S3)
  - Creates a malware protection plan
- `NewBucketKMSCopy`
  - Creates a new encrypted S3 bucket for scanning using server-side encryption with AWS KMS keys (SSE-KMS)
  - Creates a new KMS key
  - Creates an event rule and Lambda function to copy scanned files meeting the criteria
  - Creates a malware protection plan
- `NewBucketNoKMSCopy`
  - Creates a new encrypted S3 bucket for scanning using server-side encryption with S3-managed keys (SSE-S3)
  - Creates an event rule and Lambda function to copy scanned files meeting the criteria
  - Creates a malware protection plan
- `ExistingBucketNoKMSCopy`
  - Uses existing S3 buckets for scanning and copying files
  - Creates an event rule and Lambda function to copy scanned files meeting the criteria
  - Creates a malware protection plan
- `ExistingBucketKMSCopy`
  - Uses existing encrypted S3 buckets for scanning and copying files that has server-side encryption with AWS KMS keys (SSE-KMS)
  - Create an event rule and Lambda function to copy scanned files meeting the criteria
  - Creates a malware protection plan

## Deploy via the AWS Console

[The AWS CloudFormation console allows you to create, monitor, update, and delete stacks directly from your web browser](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/cfn-using-console.html)

You can follow the guided instructions of the stack to choose your scenario.

## Deploy via the AWS CLI

You will need the [install or update to the latest version of the AWS CLI](https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html).

To authenticate in your terminal window you will need to [authenticate with short-term credentials](https://docs.aws.amazon.com/cli/latest/userguide/cli-authentication-short-term.html).

### Scenario 1: New Encrypted Bucket & Protection Plan with AWS KMS keys (NewBucketKMS)

```bash
aws cloudformation create-stack \
    --stack-name NewBucketKMS \
    --capabilities CAPABILITY_IAM \
    --template-body file://./template.yaml
```

### Scenario 2: New Encrypted Bucket & Protection Plan with S3-managed keys (NewBucketNoKMS)

```bash
aws cloudformation create-stack \
    --stack-name NewBucketNoKMS \
    --capabilities CAPABILITY_IAM \
    --template-body file://./template.yaml \
    --parameters \
        ParameterKey=CreateBucketKMSKey,ParameterValue=false

```

### Scenario 3: New Bucket Encrypted Buckets with AWS KMS keys, Copy Function & Protection Plan (NewBucketKMSCopy)

```bash
aws cloudformation create-stack \
    --stack-name NewBucketKMSCopy \
    --capabilities CAPABILITY_IAM \
    --template-body file://./template.yaml \
    --parameters \
        ParameterKey=CopyToCleanBucket,ParameterValue=true
```

### Scenario 4: New Bucket Encrypted Buckets with S3-managed keys, Copy Function & Protection Plan (NewBucketNoKMSCopy)

```bash
aws cloudformation create-stack \
    --stack-name NewBucketNoKMSCopy \
    --capabilities CAPABILITY_IAM \
    --template-body file://./template.yaml \
    --parameters \
        ParameterKey=CopyToCleanBucket,ParameterValue=true \
        ParameterKey=CreateBucketKMSKey,ParameterValue=false
```

### Scenario 5: Existing Buckets no KMS Encryption, Copy Function & Protection Plan (ExistingBucketNoKMSCopy)

```bash
aws cloudformation create-stack \
    --stack-name ExistingBucketNoKMSCopy \
    --capabilities CAPABILITY_IAM \
    --template-body file://./template.yaml \
    --parameters \
        ParameterKey=NewExistingS3Bucket,ParameterValue=existing \
        ParameterKey=CopyToCleanBucket,ParameterValue=true \
        ParameterKey=CopyMethod,ParameterValue=NO_THREATS_FOUND \
        ParameterKey=BucketKMSKey,ParameterValue=false \
        ParameterKey=CreateBucketKMSKey,ParameterValue=false \
        ParameterKey=ExistingSourceBucketName,ParameterValue=$SOURCE_BUCKETNAME \
        ParameterKey=ExistingDestinationBucketName,ParameterValue=$DESTINATION_BUCKETNAME \
        ParameterKey=ExistingKMSKeyArn,ParameterValue=''

```

### Scenario 6: Existing KMS Encrypted Buckets, Copy Function & Protection Plan (ExistingBucketKMSCopy)

```bash
aws cloudformation create-stack \
    --stack-name ExistingBucketKMSCopy \
    --capabilities CAPABILITY_IAM \
    --template-body file://./template.yaml \
    --parameters \
        ParameterKey="NewExistingS3Bucket",ParameterValue=existing \
        ParameterKey="CopyToCleanBucket",ParameterValue=true \
        ParameterKey="CopyMethod",ParameterValue=NO_THREATS_FOUND \
        ParameterKey="BucketKMSKey",ParameterValue=true \
        ParameterKey="CreateBucketKMSKey",ParameterValue=true \
        ParameterKey="ExistingSourceBucketName",ParameterValue=$SOURCE_BUCKETNAME \
        ParameterKey="ExistingDestinationBucketName",ParameterValue=$DESTINATION_BUCKETNAME \
        ParameterKey="ExistingKMSKeyArn",ParameterValue="arn:aws:kms:$AWS_DEFAULT_REGION:$AWS_ACCOUNT_ID:key/$KEY"

```
