# Cloudformation Scenarios

The following scenarios are supported within the `template.yaml`.

- `NewBucketKMS`
  - Creates a new encrypted S3 bucket for scanning
  - Creates a new KMS key
  - Creates a malware protection plan
- `NewBucketKMSCopy`
  - Creates new encrypted S3 buckets for scanning and copying files
  - Creates a new KMS key
  - Creates an event rule and Lambda function to copy scanned files meeting the criteria
  - Creates a malware protection plan
- `ExistingBucketNoKMSCopy`
  - Uses existing S3 buckets for scanning and copying files
  - Creates an event rule and Lambda function to copy scanned files meeting the criteria
  - Creates a malware protection plan
- `ExistingBucketKMSCopy`
  - Uses existing encrypted S3 buckets for scanning and copying files
  - Create an event rule and Lambda function to copy scanned files meeting the criteria
  - Creates a malware protection plan

## Deploy via the AWS Console

[The AWS CloudFormation console allows you to create, monitor, update, and delete stacks directly from your web browser](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/cfn-using-console.html)

You can follow the guided instructions of the stack to choose your scenario.

## Deploy via the AWS CLI

You will need the [install or update to the latest version of the AWS CLI](https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html).

To authenticate in your terminal window you will need to [authenticate with short-term credentials](https://docs.aws.amazon.com/cli/latest/userguide/cli-authentication-short-term.html).

### Scenario 1: New Encrypted Bucket & Protection Plan (NewBucketKMS)

TODO

```bash
aws cloudformation create-stack \
    --stack-name NewBucketKMS \
    --template-body file://./template.yaml \
    --parameters \
        ParameterKey=NewExistingS3Bucket,ParameterValue=existing \
        ParameterKey=CopyToCleanBucket,ParameterValue=yes \
        ParameterKey=CopyMethod,ParameterValue=NO_THREATS_FOUND \
        ParameterKey=BucketKMSKey,ParameterValue=yes \
        ParameterKey=CreateBucketKMSKey,ParameterValue=no \
        ParameterKey=ExistingSourceBucketName,ParameterValue=<accoundId> -source-kms \
        ParameterKey=ExistingDestinationBucketName,ParameterValue=<accoundId> -destination-kms \
        ParameterKey=ExistingKMSKeyArn,ParameterValue=arn:aws:kms:<region>:<accoundId>:key/<keyId>

```

### Scenario 2: New Bucket Encrypted Buckets, Copy Function & Protection Plan (NewBucketKMSCopy)

DONE

```bash
aws cloudformation create-stack \
    --stack-name NewBucketKMSCopy \
    --template-body file://./template.yaml \
    --parameters \
        ParameterKey=NewExistingS3Bucket,ParameterValue=new \
        ParameterKey=CopyToCleanBucket,ParameterValue=true \
        ParameterKey=CopyMethod,ParameterValue=NO_THREATS_FOUND \
        ParameterKey=BucketKMSKey,ParameterValue=false \
        ParameterKey=CreateBucketKMSKey,ParameterValue=true \
        ParameterKey=ExistingSourceBucketName,ParameterValue='' \
        ParameterKey=ExistingDestinationBucketName,ParameterValue='' \
        ParameterKey=ExistingKMSKeyArn,ParameterValue=''

```

### Scenario 3: Existing Buckets (no KMS Encryption), Copy Function & Protection Plan (ExistingBucketNoKMSCopy)

DONE

```bash
aws cloudformation create-stack \
    --stack-name ExistingBucketNoKMSCopy \
    --template-body file://./template.yaml \
    --parameters \
        ParameterKey=NewExistingS3Bucket,ParameterValue=existing \
        ParameterKey=CopyToCleanBucket,ParameterValue=true \
        ParameterKey=CopyMethod,ParameterValue=NO_THREATS_FOUND \
        ParameterKey=BucketKMSKey,ParameterValue=false \
        ParameterKey=CreateBucketKMSKey,ParameterValue=false \
        ParameterKey=ExistingSourceBucketName,ParameterValue=<accoundId>-source-sg \
        ParameterKey=ExistingDestinationBucketName,ParameterValue=<accoundId>-destination-sg \
        ParameterKey=ExistingKMSKeyArn,ParameterValue=''

```

### Scenario 4: Existing Encrypted Buckets, Copy Function & Protection Plan (ExistingBucketKMSCopy)

TODO

```bash
aws cloudformation create-stack \
    --stack-name ExistingBucketKMSCopy \
    --template-body file://./template.yaml \
    --parameters \
        ParameterKey="NewExistingS3Bucket",ParameterValue="existing" \
        ParameterKey="CopyToCleanBucket",ParameterValue="yes" \
        ParameterKey="CopyMethod",ParameterValue="NO_THREATS_FOUND" \
        ParameterKey="BucketKMSKey",ParameterValue="yes" \
        ParameterKey="CreateBucketKMSKey",ParameterValue="no" \
        ParameterKey="ExistingSourceBucketName",ParameterValue="<accoundId> -source-kms" \
        ParameterKey="ExistingDestinationBucketName",ParameterValue="<accoundId>-destination-kms" \
        ParameterKey="ExistingKMSKeyArn",ParameterValue="arn:aws:kms:<region>:<accoundId>:key/<keyId>"

```
